# 笔记

## 登录

```
csrf token -> token -> get page
```

## 等级限制

例如，用户 A 目前为 2 级，访问需求等级为 3 的小说，示例链接：https://masiro.me/admin/novelView?novel_id=1033 ,响应正常，
但是会出现一个“小孩子不能看”的页面。

处理策略：代码中检测“小孩子不能看”类似的关键信息，终止程序，并通过terminal告知程序运行者。

可以说，**等级限制是最严格的限制，即使你有很多积分，但没有足够的等级，部分小说依然是无权购买的**。

## 积分购买

首先，寻找一个需要积分的小说来进行分析，例如：https://masiro.me/admin/novelView?novel_id=14 。

选取一个需要扣除积分的章节项目，它的链接属性是 https://masiro.me/admin/novelReading?cid=22681 ，页面上显示需要扣除2G，即2个积分。

a) 点击这个项目，弹出modal层，选择是否支付积分。

b) 直接访问上面的章节链接：https://masiro.me/admin/novelReading?cid=22681 ，显示“立即打钱”页面，分析页面源码如下：

```html

<div class="col-md-12">
    <div class="error-box">
        <div class="hint"><p>
            书名：
            <a href="/admin/novelView?novel_id=14">独自一人的异世界攻略</a></p>
            <p>章节：<a href="">黑发之国</a></p>
        </div>
        <img src="/images/打钱.png" alt="打钱.png">
        <p class="hint-btn pay">立即打钱</p>
    </div>
    <input type="hidden" value="2" class="cost">
    <input type="hidden" value="2" class="type">
    <input type="hidden" value="22681" class="object_id">
    <input type="hidden" name="_token" value="XXXXXXXXXXXXXXXXX" class="csrf">
</div>
```

留意四个隐藏的input：

- cost 表示积分数值
- type 为 2，推测是表示支付类型
- object_id 指的是chapter_id
- _token 这个值是csrf-token

如何实际地发起请求，还是通过network面板捕获分析。请求标头中必须携带这两个关键字段：

```
X-Csrf-Token: XXXXXXXXXXXXXXXXXXXXXX
X-Requested-With: XMLHttpRequest
```

表单数据：

```
type: 2
object_id: 22681
cost: 2
```

购买成功后，响应是如下，最后跳转到内容界面。

```json
{
  "code": 1,
  "msg": "支付成功！"
}
```

此外，下次再访问这个已经购买的章节链接，不需要再次购买，而是直接跳转到内容页面。

解决方案：由于在小说目录会显示每一个章节的积分价格，同时积分是一种昂贵的代币，因此爬虫之前，最好列出本次爬虫一共需要消耗的累计积分预计
，然后请求用户再次确认。用户的当前积分，在登录时，爬虫可以直接获取到。通过用户当前积分和消耗积分预计值得对比，可以清晰地将选择权交给使用者。

### 程序实现

积分购买，分卷下载，这部分逻辑会牵扯在一起。因此这里将进行仔细分析，然后给出详细设计，来指导代码实现。

1. 爬取获得完全的书籍目录，此时可以获取每个章节所需要花费的积分，以及每卷需要花费的积分合计。
2. 根据用户是否分卷下载：
   - 2.1 分卷 => 被动显示卷列表（显示每卷积分消耗值），给用户挑选。#1
   - 2.2 不分卷 => 情况复杂，需要进一步分析
     - 2.2.1 如果本书所有章节都是不需要积分查看的 => **直接起飞，分支结束**。
     - 2.2.2 如果本书部分章节需要积分查看，因为涉及到代币，所以最佳做法是再次询问。=> #2

- #1，这个分支下，用户已经可以率先了解每卷的积分消耗预计。用户挑选后，得到选择的卷列表。根据
  用户选择的卷，计算积分消耗总累计值，和当前用户的积分余额对比，
  - 如果用户积分余额 >= 挑选卷的积分总累计值，询问用户是否继续下载， **Y => 扣除积分，继续；N => 退出程序**。
  - 如果用户积分余额 < 挑选卷的积分总累计值，**直接告知用户积分不够，退出程序**。
- #2，这个分支下，主动向用户显示卷列表，并展示本书需要消耗的积分合计。
  - 如果用户积分余额 >= 本书的积分总累计值，询问用户是否继续下载， **Y => 扣除积分，继续；N => 退出程序**。
  - 如果用户积分余额 < 本书的积分总累计值，**直接告知用户积分不够，退出程序**。
        
